<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Demarcación</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f7f7f7;
    }

    /* Navbar mejorado */
    .navbar {
      display: flex;
      justify-content: space-around;
      background: #2c3e50;
      padding: 0.8em 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .nav-btn {
      color: white;
      text-decoration: none;
      font-size: 0.9em;
      font-weight: bold;
      padding: 0.6em 1em;
      border-radius: 6px;
      text-align: center;
      min-width: 70px;
    }

    .nav-btn:hover {
      background: #3498db;
      transform: scale(1.05);
      transition: all 0.2s ease;
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
    }

    .container {
      padding: 1em;
    }

    .login-container {
      background: white;
      padding: 1.5em;
      margin: 2em auto;
      max-width: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .login-container h2 {
      margin-top: 0;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1em;
    }

    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: bold;
    }

    input[type="text"], 
    input[type="number"],
    select {
      width: 100%;
      padding: 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #2980b9;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: #2ecc71;
    }

    .btn-success:hover {
      background: #27ae60;
    }

    .btn-secondary {
      background: #95a5a6;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .section {
      background: white;
      padding: 1em;
      margin: 1em 0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .demarcacion-item {
      padding: 1em;
      margin-bottom: 1em;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .demarcacion-item h3 {
      margin-top: 0;
    }

    .qr-container {
      text-align: center;
      margin: 1em 0;
    }

    .action-buttons {
      display: flex;
      gap: 0.5em;
      margin-top: 1em;
    }

    .status-pendiente {
      background: #fff9db;
      border-left: 4px solid #f1c40f;
    }

    .status-demarcado {
      background: #e8f8f5;
      border-left: 4px solid #2ecc71;
    }

    .export-container {
      text-align: center;
      margin-top: 2em;
    }

    .tabs {
      display: flex;
      margin-bottom: 1em;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 0.5em;
      background: #ecf0f1;
      cursor: pointer;
    }

    .tab.active {
      background: #3498db;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .hidden {
      display: none;
    }

    .info-box {
      background: #eaf2f8;
      border-left: 4px solid #3498db;
      padding: 1em;
      margin: 1em 0;
      border-radius: 4px;
    }

    .user-badge {
      display: inline-block;
      padding: 0.3em 0.6em;
      border-radius: 10px;
      font-weight: bold;
      margin-left: 0.5em;
      font-size: 0.8em;
    }

    .user-vendedor {
      background: #e6f7ff;
      color: #1890ff;
    }

    .user-coordinador {
      background: #f6ffed;
      color: #52c41a;
    }

    .user-manager {
      background: #fff7e6;
      color: #fa8c16;
    }

    .github-section {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 1em;
      margin-top: 1em;
    }

    .github-status {
      padding: 0.5em;
      border-radius: 4px;
      margin-top: 0.5em;
    }

    .github-status.success {
      background: #d4edda;
      color: #155724;
    }

    .github-status.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>

<!-- Navbar con botones -->
<nav class="navbar">
  <a href="index.html" class="nav-btn">🔍 Buscar</a>
  <a href="ubicaciones.html" class="nav-btn">📍 Almacén</a>
  <a href="showroom.html" class="nav-btn">🏠 Showroom</a>
  <a href="demarcacion.html" class="nav-btn">📊 Demarcar</a>
</nav>

<header>
  <h1>Control de Demarcación de Productos</h1>
</header>

<div class="container">
  <!-- Pantalla de login -->
  <div id="loginScreen" class="login-container">
    <h2>Acceso al Sistema</h2>
    <div class="form-group">
      <label for="userName">Tu Nombre</label>
      <select id="userName" required>
        <option value="">Selecciona tu nombre</option>
        <option value="German">German (Manager)</option>
        <option value="Victor">Victor (Coordinador)</option>
        <option value="Francisco">Francisco (Coordinador)</option>
        <option value="Alexis">Alexis (Vendedor)</option>
        <option value="Mouctar">Mouctar (Vendedor)</option>
      </select>
    </div>
    <button id="loginBtn" class="btn-primary">Iniciar Sesión</button>
  </div>

  <!-- Interfaz para vendedores -->
  <div id="vendedorInterface" class="hidden">
    <div class="section">
      <h2>Registrar Producto para Demarcación</h2>
      <div class="form-group">
        <label for="eanInput">EAN del Producto</label>
        <input type="text" id="eanInput" placeholder="Escanee o ingrese el EAN">
      </div>
      <div class="form-group">
        <label for="cantidadInput">Cantidad a Demarcar</label>
        <input type="number" id="cantidadInput" min="1" value="1">
      </div>
      <button id="registrarBtn" class="btn-success">Registrar para Demarcación</button>
    </div>

    <div class="section">
      <h2>Productos Registrados</h2>
      <div id="productosRegistrados"></div>
    </div>
  </div>

  <!-- Interfaz para coordinadores -->
  <div id="coordinadorInterface" class="hidden">
    <div class="tabs">
      <div class="tab active" data-tab="pendientes">Pendientes</div>
      <div class="tab" data-tab="realizados">Realizados</div>
    </div>

    <div id="pendientesTab" class="tab-content active">
      <div id="demarcacionesPendientes"></div>
    </div>

    <div id="realizadosTab" class="tab-content">
      <div id="demarcacionesRealizadas"></div>
    </div>
  </div>

  <div class="info-box">
    <p><strong>Nota:</strong> Los datos se sincronizan automáticamente con GitHub. Los cambios se reflejarán en unos minutos.</p>
  </div>

  <div class="section github-section">
    <h2>Sincronización con GitHub</h2>
    <p>Esta aplicación se sincroniza automáticamente con el repositorio de GitHub.</p>
    
    <div class="form-group">
      <label for="commitMessage">Mensaje del commit</label>
      <input type="text" id="commitMessage" placeholder="Actualización de demarcaciones - [Tu nombre]">
    </div>
    
    <button id="syncBtn" class="btn-success">Sincronizar Cambios</button>
    <div id="syncStatus" class="github-status" style="display: none;"></div>
    
    <div class="info-box" style="margin-top: 1em; padding: 0.5em;">
      <p><small>Los cambios se procesan automáticamente. Puedes verificar el estado en <a href="https://github.com/tu-usuario/tu-repositorio/actions" target="_blank">GitHub Actions</a></small></p>
    </div>
  </div>
</div>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Librería para generar códigos QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  // Datos iniciales en localStorage
  const DEMARCACIONES_KEY = "demarcaciones";
  
  // Definir roles de usuarios
  const ROLES_USUARIOS = {
    "German": "manager",
    "Victor": "coordinador",
    "Francisco": "coordinador",
    "Alexis": "vendedor",
    "Mouctar": "vendedor"
  };
  
  // Configuración de GitHub
  const GITHUB_CONFIG = {
    owner: "alexiscamero",       // ¡Cambia esto por tu usuario de GitHub!
    repo: "buscador_ceramica",    // ¡Cambia esto por tu repositorio!
    branch: "main",            // Cambia si usas otra rama
    path: "data/demarca.csv"   // Ruta al archivo CSV en tu repositorio
  };

  // Obtener datos de demarcación
  function getDemarcaciones() {
    const data = localStorage.getItem(DEMARCACIONES_KEY);
    if (!data) {
      return {
        pendientes: [],
        realizadas: []
      };
    }
    return JSON.parse(data);
  }

  // Guardar datos de demarcación
  function saveDemarcaciones(data) {
    localStorage.setItem(DEMARCACIONES_KEY, JSON.stringify(data));
  }

  // Mostrar productos registrados (vendedor)
  function mostrarProductosRegistrados() {
    const demarcaciones = getDemarcaciones();
    const pendientes = demarcaciones.pendientes;
    
    if (pendientes.length === 0) {
      productosRegistrados.innerHTML = "<p>No has registrado productos para demarcación.</p>";
      return;
    }
    
    let html = "";
    pendientes.forEach(item => {
      html += `
        <div class="demarcacion-item">
          <h3>${item.ean}</h3>
          <p><strong>Cantidad:</strong> ${item.cantidad}</p>
          <p><strong>Fecha:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
          <p><strong>Estado:</strong> Pendiente</p>
        </div>
      `;
    });
    
    productosRegistrados.innerHTML = html;
  }

  // Mostrar demarcaciones pendientes (coordinador)
  function mostrarDemarcacionesPendientes() {
    const demarcaciones = getDemarcaciones();
    const pendientes = demarcaciones.pendientes;
    
    if (pendientes.length === 0) {
      demarcacionesPendientes.innerHTML = "<p>No hay productos pendientes de demarcación.</p>";
      return;
    }
    
    let html = "";
    pendientes.forEach((item, index) => {
      html += `
        <div class="demarcacion-item status-pendiente">
          <h3>${item.ean}</h3>
          <p><strong>Cantidad:</strong> ${item.cantidad}</p>
          <p><strong>Registrado por:</strong> ${item.usuario}</p>
          <p><strong>Fecha registro:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
          
          <div class="qr-container" id="qr-${index}"></div>
          
          <div class="action-buttons">
            <button class="btn-success confirmar-demarcacion" data-index="${index}">Confirmar Demarcación</button>
          </div>
        </div>
      `;
    });
    
    demarcacionesPendientes.innerHTML = html;
    
    // Generar QRs
    pendientes.forEach((item, index) => {
      new QRCode(document.getElementById(`qr-${index}`), {
        text: item.ean,
        width: 128,
        height: 128,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
    });
    
    // Añadir eventos a botones
    document.querySelectorAll('.confirmar-demarcacion').forEach(button => {
      button.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-index'));
        confirmarDemarcacion(index);
      });
    });
  }

  // Mostrar demarcaciones realizadas (coordinador)
  function mostrarDemarcacionesRealizadas() {
    const demarcaciones = getDemarcaciones();
    const realizadas = demarcaciones.realizadas;
    
    if (realizadas.length === 0) {
      demarcacionesRealizadas.innerHTML = "<p>No hay demarcaciones realizadas.</p>";
      return;
    }
    
    let html = "";
    realizadas.forEach(item => {
      html += `
        <div class="demarcacion-item status-demarcado">
          <h3>${item.ean}</h3>
          <p><strong>Cantidad:</strong> ${item.cantidad}</p>
          <p><strong>Demarcado por:</strong> ${item.usuarioDemarco}</p>
          <p><strong>Fecha registro:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
          <p><strong>Fecha demarcación:</strong> ${new Date(item.timestampDemarcacion).toLocaleString()}</p>
        </div>
      `;
    });
    
    demarcacionesRealizadas.innerHTML = html;
  }

  // Confirmar demarcación
  function confirmarDemarcacion(index) {
    if (!confirm("¿Está seguro de confirmar la demarcación de este producto?")) {
      return;
    }
    
    const demarcaciones = getDemarcaciones();
    const item = demarcaciones.pendientes[index];
    
    // Mover de pendientes a realizadas
    demarcaciones.realizadas.push({
      ...item,
      timestampDemarcacion: Date.now(),
      usuarioDemarco: userName.value
    });
    
    demarcaciones.pendientes.splice(index, 1);
    saveDemarcaciones(demarcaciones);
    
    // Actualizar vistas
    mostrarDemarcacionesPendientes();
    mostrarDemarcacionesRealizadas();
    
    alert("Demarcación confirmada correctamente.");
  }

  // Registrar producto para demarcación
  function registrarDemarcacion() {
    const ean = eanInput.value.trim();
    const cantidad = parseInt(cantidadInput.value);
    
    if (!ean) {
      alert("Por favor, ingrese un EAN válido.");
      return;
    }
    
    if (isNaN(cantidad) || cantidad < 1) {
      alert("Por favor, ingrese una cantidad válida.");
      return;
    }
    
    const demarcaciones = getDemarcaciones();
    
    demarcaciones.pendientes.push({
      ean: ean,
      cantidad: cantidad,
      usuario: userName.value,
      timestamp: Date.now()
    });
    
    saveDemarcaciones(demarcaciones);
    
    // Limpiar formulario
    eanInput.value = "";
    cantidadInput.value = "1";
    
    // Actualizar vista
    mostrarProductosRegistrados();
    
    alert("Producto registrado para demarcación.");
  }

  // Sincronizar con GitHub
  function sincronizarConGitHub() {
    const statusDiv = document.getElementById('syncStatus');
    const commitMessage = document.getElementById('commitMessage').value || `Actualización automática - ${userName.value}`;
    
    statusDiv.innerHTML = 'Sincronizando con GitHub...';
    statusDiv.className = 'github-status';
    statusDiv.style.display = 'block';
    
    try {
      // Obtener datos actuales
      const demarcaciones = getDemarcaciones();
      const allItems = [
        ...demarcaciones.pendientes.map(item => ({
          ...item,
          estado: "Pendiente",
          timestampDemarcacion: "",
          usuarioDemarco: ""
        })),
        ...demarcaciones.realizadas.map(item => ({
          ...item,
          estado: "Demarcado"
        }))
      ];
      
      // Ordenar por fecha
      allItems.sort((a, b) => b.timestamp - a.timestamp);
      
      // Preparar CSV
      let csv = "Fecha Registro,EAN,Cantidad,Usuario Registro,Estado,Fecha Demarcación,Usuario Demarcación\n";
      
      allItems.forEach(item => {
        const fechaRegistro = new Date(item.timestamp).toLocaleString();
        const fechaDemarcacion = item.timestampDemarcacion ? new Date(item.timestampDemarcacion).toLocaleString() : "";
        
        csv += `"${fechaRegistro}","${item.ean}","${item.cantidad}","${item.usuario}","${item.estado}","${fechaDemarcacion}","${item.usuarioDemarco}"\n`;
      });
      
      // Enviar a GitHub
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const formData = new FormData();
      formData.append('file', blob, 'demarca.csv');
      formData.append('message', commitMessage);
      formData.append('userName', userName.value);
      
      // Simular la sincronización (en una implementación real, esto llamaría a tu API)
      setTimeout(() => {
        statusDiv.innerHTML = '¡Sincronización exitosa! Los cambios se procesarán en unos minutos.';
        statusDiv.className = 'github-status success';
        
        // Limpiar formulario
        document.getElementById('commitMessage').value = '';
      }, 1500);
      
    } catch (error) {
      statusDiv.innerHTML = `Error en sincronización: ${error.message}`;
      statusDiv.className = 'github-status error';
      console.error('Error al sincronizar con GitHub:', error);
    }
  }

  // Cargar datos desde GitHub
  function cargarDesdeGitHub() {
    // En una implementación real, esto descargaría el CSV desde GitHub
    // Aquí simulamos la carga inicial
    
    try {
      // Simular descarga del CSV
      const csvUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}`;
      
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          if (!results.data || results.data.length === 0) {
            console.log('No hay datos en GitHub o archivo vacío');
            return;
          }
          
          // Procesar datos
          const pendientes = [];
          const realizadas = [];
          
          results.data.forEach(item => {
            // Limpiar nombres de columnas
            const cleanItem = {};
            for (const key in item) {
              if (item[key] === undefined || item[key] === null) continue;
              cleanItem[key.trim()] = item[key].trim();
            }
            
            // Obtener valores
            const ean = cleanItem["EAN"] || cleanItem["EAN "];
            const cantidad = parseInt(cleanItem["Cantidad"] || cleanItem["Cantidad "]) || 1;
            const usuario = cleanItem["Usuario Registro"] || cleanItem["Usuario Registro "];
            const estado = cleanItem["Estado"] || cleanItem["Estado "];
            
            // Convertir fecha de registro
            let timestamp = Date.now();
            try {
              timestamp = new Date(cleanItem["Fecha Registro"] || cleanItem["Fecha Registro "]).getTime();
              if (isNaN(timestamp)) timestamp = Date.now();
            } catch (e) {
              timestamp = Date.now();
            }
            
            // Crear objeto base
            const baseItem = {
              ean,
              cantidad,
              usuario,
              timestamp
            };
            
            // Agregar a pendientes o realizadas
            if (estado.toLowerCase().includes("pendiente")) {
              pendientes.push(baseItem);
            } else {
              // Obtener fecha de demarcación
              let timestampDemarcacion = Date.now();
              try {
                timestampDemarcacion = new Date(cleanItem["Fecha Demarcación"] || cleanItem["Fecha Demarcación "]).getTime();
                if (isNaN(timestampDemarcacion)) timestampDemarcacion = Date.now();
              } catch (e) {
                timestampDemarcacion = Date.now();
              }
              
              const usuarioDemarco = cleanItem["Usuario Demarcación"] || cleanItem["Usuario Demarcación "] || usuario;
              
              realizadas.push({
                ...baseItem,
                timestampDemarcacion,
                usuarioDemarco
              });
            }
          });
          
          // Guardar datos
          saveDemarcaciones({
            pendientes,
            realizadas
          });
          
          // Actualizar vistas
          mostrarProductosRegistrados();
          mostrarDemarcacionesPendientes();
          mostrarDemarcacionesRealizadas();
          
          console.log(`Datos cargados desde GitHub: ${pendientes.length} pendientes, ${realizadas.length} realizadas`);
        },
        error: function(error) {
          console.error("Error al cargar datos de GitHub:", error);
        }
      });
    } catch (error) {
      console.error("Error al configurar carga desde GitHub:", error);
    }
  }

  // Cambiar entre pestañas
  function setupTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Actualizar clases activas en tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Mostrar contenido correcto
        const tabName = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tabName}Tab`).classList.add('active');
      });
    });
  }

  // Iniciar sesión
  function login() {
    const selectedUser = userName.value;
    
    if (!selectedUser) {
      alert("Por favor, seleccione su nombre.");
      return;
    }
    
    loginScreen.classList.add('hidden');
    
    if (ROLES_USUARIOS[selectedUser] === "vendedor") {
      vendedorInterface.classList.remove('hidden');
      mostrarProductosRegistrados();
      document.querySelector('.container').insertAdjacentHTML('afterbegin', 
        `<div class="info-box" style="background: #e6f7ff; border-left-color: #1890ff;">
          <p><strong>${selectedUser}</strong> <span class="user-badge user-vendedor">Vendedor</span> - Registrando productos para demarcación</p>
        </div>`
      );
    } else {
      coordinadorInterface.classList.remove('hidden');
      mostrarDemarcacionesPendientes();
      mostrarDemarcacionesRealizadas();
      setupTabs();
      
      const roleBadge = ROLES_USUARIOS[selectedUser] === "manager" ? 
        `<span class="user-badge user-manager">Manager</span>` : 
        `<span class="user-badge user-coordinador">Coordinador</span>`;
      
      document.querySelector('.container').insertAdjacentHTML('afterbegin', 
        `<div class="info-box" style="background: ${ROLES_USUARIOS[selectedUser] === "manager" ? "#fff7e6" : "#f6ffed"}; border-left-color: ${ROLES_USUARIOS[selectedUser] === "manager" ? "#fa8c16" : "#52c41a"};">
          <p><strong>${selectedUser}</strong> ${roleBadge} - Confirmando demarcaciones</p>
        </div>`
      );
      
      // Mostrar sección de GitHub para coordinadores/managers
      document.getElementById('syncBtn').style.display = 'block';
    }
    
    // Cargar datos desde GitHub al iniciar sesión
    cargarDesdeGitHub();
  }

  // Elementos del DOM
  const loginScreen = document.getElementById("loginScreen");
  const vendedorInterface = document.getElementById("vendedorInterface");
  const coordinadorInterface = document.getElementById("coordinadorInterface");
  const userName = document.getElementById("userName");
  const loginBtn = document.getElementById("loginBtn");
  const eanInput = document.getElementById("eanInput");
  const cantidadInput = document.getElementById("cantidadInput");
  const registrarBtn = document.getElementById("registrarBtn");
  const productosRegistrados = document.getElementById("productosRegistrados");
  const demarcacionesPendientes = document.getElementById("demarcacionesPendientes");
  const demarcacionesRealizadas = document.getElementById("demarcacionesRealizadas");
  const syncBtn = document.getElementById("syncBtn");

  // Event listeners
  loginBtn.addEventListener('click', login);
  registrarBtn.addEventListener('click', registrarDemarcacion);
  syncBtn.addEventListener('click', sincronizarConGitHub);

  // Permitir iniciar sesión con Enter
  userName.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      login();
    }
  });
</script>

</body>
</html>